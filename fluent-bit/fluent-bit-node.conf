[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# Host system logs from journald
[INPUT]
    Name              systemd
    Tag               host.*
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Systemd_Filter    _SYSTEMD_UNIT=sshd.service
    Systemd_Filter    _SYSTEMD_UNIT=systemd-journald.service
    Read_From_Tail    On
    Path              /run/log/journal

# Docker container logs (JSON format)
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Refresh_Interval  10
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /var/log/flb_docker.db

# Extract container name from log path
[FILTER]
    Name              parser
    Match             docker.*
    Key_Name          log
    Parser            docker
    Reserve_Data      On

# Add hostname label to all logs (set NODE_HOSTNAME in .env)
[FILTER]
    Name              record_modifier
    Match             *
    Record            hostname ${NODE_HOSTNAME}

# Output to central Loki server (pimento via Tailscale)
[OUTPUT]
    Name              loki
    Match             host.*
    Host              100.117.69.115
    Port              3100
    Labels            job=journald, host=${NODE_HOSTNAME}
    Label_Keys        $SYSLOG_IDENTIFIER,$_SYSTEMD_UNIT
    Remove_Keys       _BOOT_ID,_CAP_EFFECTIVE,_CMDLINE,_COMM,_EXE,_GID,_MACHINE_ID,_PID,_SELINUX_CONTEXT,_STREAM_ID,_SYSTEMD_CGROUP,_SYSTEMD_INVOCATION_ID,_SYSTEMD_SLICE,_TRANSPORT,_UID

[OUTPUT]
    Name              loki
    Match             docker.*
    Host              100.117.69.115
    Port              3100
    Labels            job=docker, host=${NODE_HOSTNAME}
    Auto_Kubernetes_Labels Off
